# remote-chrome-e2e スキル設計

## Context

remote-chrome プラグインには `control` (osascript操作) と `screenshot` (Playwrightスクショ) の2つのスキルがあるが、「操作してからスクリーンショット」というユースケースに対応する統合スキルがない。control は GUI Chrome、screenshot は新規 headless Chrome を使うため、操作後の状態をキャプチャできない。

## Decision

Playwright-core のフルAPIを使い、Claude が状況に応じてスクリプトを都度生成する **テンプレート拡張方式** を採用する。

### 却下したアプローチ

- **アクション DSL 方式**: JSON で操作を指定。表現力に限界があり、条件分岐や動的待機が困難。
- **osascript + Playwright 二段構え**: 2つのブラウザで状態が不一致になるため、操作後の状態キャプチャという要件を満たせない。

## Skill Structure

```
plugins/remote-chrome/skills/remote-chrome-e2e/
├── SKILL.md                         # 6 Phase ワークフロー
├── references/
│   └── playwright-actions.md        # Playwright API クイックリファレンス
└── scripts/
    └── pw_template.mjs              # ボイラープレートテンプレート
```

### 既存スキルとの使い分け

| スキル | 用途 |
|--------|------|
| `remote-chrome-control` | osascript で GUI Chrome を操作(タブ管理、URL遷移) |
| `remote-chrome-screenshot` | 単純なスクショ(URLアクセス + 待機 + キャプチャ) |
| `remote-chrome-e2e` (NEW) | 操作 + 検証 + スクショ(Claude が Playwright スクリプト生成) |

## Workflow (6 Phases)

### Phase 1: 環境確認
- tmux MCP ロード
- `.claude/remote-chrome.local.md` 読み取り

### Phase 2: リバーストンネル構築
- ローカルアプリへのアクセスが必要な場合のみ

### Phase 3: Playwright 環境準備
- `npm install playwright-core`

### Phase 4: スクリプト生成 + 転送
- Claude がユーザーの要望に基づいて Playwright スクリプトを生成
- `scripts/pw_template.mjs` をベースにカスタマイズ
- `references/playwright-actions.md` を参照して適切な API を選択
- base64 エンコードでリモートに転送

### Phase 5: 実行 + 検証
- `node /tmp/pw_e2e.mjs` 実行
- コンソール出力で検証(タイトル、テキスト、操作結果)
- スクリーンショットファイル生成確認

### Phase 6: ファイル転送 + クリーンアップ
- HTTP サーバー経由でローカルに転送
- `Read` ツールで画像確認
- クリーンアップ

## Template Script (`pw_template.mjs`)

```javascript
#!/usr/bin/env node
// pw_e2e.mjs - E2E verification + screenshot
// Generated by Claude based on user requirements
import { chromium } from 'playwright-core';

const browser = await chromium.launch({
  executablePath: '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome',
  headless: true,
  args: ['--no-sandbox', '--disable-gpu'],
});

try {
  const page = await browser.newPage({ viewport: { width: 1920, height: 1080 } });

  // --- Navigation ---
  await page.goto('http://localhost:23000/', {
    waitUntil: 'domcontentloaded',
    timeout: 15000,
  });

  // --- Custom Actions (Claude generates here) ---
  // await page.click('.notification-card');
  // await page.fill('#input', 'test');
  // await page.waitForSelector('.result');

  // --- Verification ---
  const title = await page.title();
  console.log(`Title: ${title}`);

  // --- Screenshot ---
  await page.screenshot({ path: '/tmp/pw_e2e.png', fullPage: false });
  console.log('Screenshot saved.');
} catch (e) {
  console.error('ERROR:', e.message);
  process.exitCode = 1;
} finally {
  await browser.close();
}
```

## Playwright Actions Reference

`references/playwright-actions.md` に以下のカテゴリを記載:

- Navigation: `goto`, `reload`, `goBack`
- Click: `click`, `dblclick`
- Input: `fill`, `type`, `selectOption`
- Wait: `waitForSelector`, `waitForTimeout`, `waitForURL`
- Query: `title`, `textContent`, `innerHTML`, `locator().count()`
- Assert: `isVisible`, `isEnabled`
- Screenshot: `page.screenshot()`, `locator().screenshot()`

## Version Plan

- remote-chrome: v1.1.0 -> v1.2.0
- marketplace: v3.11.0 -> v3.12.0
